# main.ts リファクタリング計画

## 🎯 **現在の問題点**

### **ファイルサイズ・構造**
- ✅ **1802行の巨大ファイル** - 責任が分散されていない
- ✅ **20個以上のグローバルDOM要素取得** - エラーハンドリング不足
- ✅ **複数のグローバル変数** - 状態管理が散漫
- ✅ **長大な関数** - `updateDisplay`、`drawCompassDisplay`など

### **コード品質**
- ❌ **重複したロジック** - 位置情報処理、方向計算など
- ❌ **エラーハンドリング不足** - DOM取得、API呼び出し
- ❌ **テスタビリティの低さ** - 依存関係が複雑
- ❌ **型安全性の不足** - any型の使用、null安全性

---

## 🚀 **実装済みリファクタリング**

### **1. DOM管理の統一**
✅ **`DOMManager`クラス作成**
- 要素取得の一元化
- エラーハンドリング統合
- キャッシュ機能
- 型安全性の向上

### **2. 状態管理の一元化**
✅ **`StateManager`クラス作成**
- アプリケーション状態の統合
- リアクティブな状態変更通知
- 型安全な状態管理
- 副作用の最小化

### **3. コンポーネント分割**
✅ **`MoonInfoDisplay`クラス作成**
- 月情報表示の専門化
- 状態変更への自動反応
- 責任の明確化

✅ **`LocationManager`クラス作成**
- 位置情報取得の専門化
- エラーハンドリングの改善
- 監視機能の管理

---

## 📋 **今後のリファクタリング項目**

### **優先度: 高**

#### **1. コンパス関連の分離**
```typescript
class CompassManager {
    // コンパス描画ロジック
    // 音声制御
    // センサー管理
}
```

#### **2. センサー管理の統合**
```typescript
class SensorManager {
    // デバイス方向センサー
    // 方位補正
    // キャリブレーション
}
```

#### **3. オーディオ管理の分離**
```typescript
class AudioManager {
    // コンパス音
    // 警告音
    // ボリューム制御
}
```

### **優先度: 中**

#### **4. UI管理の統合**
```typescript
class UIManager {
    // ダイアログ管理
    // ボタン制御
    // 設定画面
}
```

#### **5. 計算ロジックの分離**
```typescript
class MoonCalculator {
    // 角度差計算
    // 方向判定
    // 時間計算
}
```

### **優先度: 低**

#### **6. イベント管理の統合**
```typescript
class EventManager {
    // センサーイベント
    // UIイベント
    // リサイズイベント
}
```

---

## 💡 **期待される効果**

### **保守性**
- 📦 **モジュール化** - 責任の明確化
- 🔍 **デバッグ容易性** - 問題箇所の特定が簡単
- 📝 **コード可読性** - 意図が明確

### **品質**
- 🛡️ **型安全性** - TypeScriptの活用
- ⚠️ **エラーハンドリング** - 例外処理の改善
- 🧪 **テスタビリティ** - 単体テストが可能

### **パフォーマンス**
- 🚀 **初期化速度** - 遅延読み込み
- 💾 **メモリ効率** - 適切なリソース管理
- 🔄 **レンダリング** - 効率的な再描画

---

## 🎯 **次のステップ**

1. **CompassManager の実装**
2. **main.ts のリファクタリング開始**
3. **型定義の整備**
4. **エラーハンドリングの強化**
5. **テストケースの追加**
